name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # =====================
  # JOB 1: Test and Build
  # =====================
  test-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS files
        run: git lfs pull

      - name: Verify model files
        run: |
          echo "Checking model files..."
          ls -lh models/
          file models/*.pt || true

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          docker system prune -af
          docker volume prune -f
          df -h

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          pip install --prefer-binary --no-cache-dir -r requirements.txt
          pip install --prefer-binary --no-cache-dir -r requirements-dev.txt

      - name: Lint (flake8)
        run: |
          flake8 src tests \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics

      - name: Run tests
        run: |
          pytest tests --maxfail=1 --disable-warnings -q

      # Docker build and push (main branch only)
      - name: Set up Docker Buildx
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push Docker image
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/cats-dogs-classifier:latest
            ${{ secrets.DOCKER_USERNAME }}/cats-dogs-classifier:${{ github.sha }}

  # =====================
  # JOB 2: Deploy (main branch only)
  # =====================
  deploy:
    runs-on: ubuntu-latest
    needs: test-and-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS files
        run: git lfs pull

      - name: Verify files exist
        run: |
          echo "=== Models folder ==="
          ls -lh models/ || echo "No models folder"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull latest image
        run: |
          docker pull ${{ secrets.DOCKER_USERNAME }}/cats-dogs-classifier:latest || echo "No existing image found"

      - name: Stop existing containers
        run: |
          docker compose -f deployment/docker-compose.yml down --remove-orphans || true
          docker rm -f cats-dogs-classifier 2>/dev/null || true

      - name: Deploy service
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          echo "Starting deployment..."
          docker compose -f deployment/docker-compose.yml up -d --pull always
          echo "Container started. Waiting for health check..."
          sleep 10

      - name: Wait for service to be healthy
        run: |
          echo "Checking container status..."
          MAX_ATTEMPTS=40
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS"
            
            CONTAINER_STATUS=$(docker inspect -f '{{.State.Status}}' cats-dogs-classifier 2>/dev/null || echo "not_found")
            echo "  Container status: $CONTAINER_STATUS"
            
            if [ "$CONTAINER_STATUS" = "not_found" ]; then
              docker compose -f deployment/docker-compose.yml ps
              sleep 5
              continue
            fi
            
            if [ "$CONTAINER_STATUS" != "running" ]; then
              sleep 5
              continue
            fi
            
            HEALTH=$(docker inspect -f '{{.State.Health.Status}}' cats-dogs-classifier 2>/dev/null || echo "no_health")
            echo "  Health status: $HEALTH"
            
            if [ "$HEALTH" = "healthy" ]; then
              echo "Service is healthy!"
              exit 0
            fi
            
            if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
              echo "Health endpoint responding!"
              exit 0
            fi
            
            sleep 5
          done
          
          echo "=== DEPLOYMENT FAILED ==="
          docker logs cats-dogs-classifier 2>&1 | tail -100
          exit 1

      - name: Run smoke tests
        run: |
          echo "=== Running Smoke Tests ==="
          
          echo "1. Testing health endpoint..."
          curl -sf http://localhost:8000/health
          
          echo "2. Testing root endpoint..."
          curl -sf http://localhost:8000/
          
          echo "3. Testing metrics endpoint..."
          curl -sf http://localhost:8000/metrics
          
          echo "4. Testing prediction endpoint..."
          python3 << 'EOF'
          from PIL import Image
          img = Image.new("RGB", (224, 224), color=(100, 150, 200))
          img.save("test_image.jpg", "JPEG")
          EOF
          
          curl -sf -X POST "http://localhost:8000/predict" \
            -H "accept: application/json" \
            -F "file=@test_image.jpg"
          
          rm -f test_image.jpg
          echo ""
          echo "=== All smoke tests passed! ==="

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Deployment Failed ==="
          docker ps -a
          docker logs cats-dogs-classifier 2>&1 || true
          docker compose -f deployment/docker-compose.yml config

      - name: Cleanup on failure
        if: failure()
        run: |
          docker compose -f deployment/docker-compose.yml down --remove-orphans || true



