name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [main]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Pull latest image
      run: |
        docker pull ${{ secrets.DOCKER_USERNAME }}/cats-dogs-classifier:latest
    
    - name: Deploy with Docker Compose
      run: |
        # Stop existing services
        docker-compose -f deployment/docker-compose.yml down || true
        
        # Deploy new version
        docker-compose -f deployment/docker-compose.yml up -d cats-dogs-classifier
        
        # Wait for service to be ready
        sleep 15
    
    - name: Run smoke tests
      run: |
        # Health check
        echo "Testing health endpoint..."
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health)
        if [ $response -ne 200 ]; then
          echo "Health check failed with status $response"
          exit 1
        fi
        echo "Health check passed"
        
        # Test prediction endpoint with a sample
        echo "Testing prediction endpoint..."
        
        # Create a simple test image (blue square)
        python3 - <<EOF
        from PIL import Image
        import numpy as np
        img = Image.new('RGB', (224, 224), color='blue')
        img.save('test_image.jpg')
        EOF
        
        # Test prediction
        response=$(curl -s -X POST "http://localhost:8000/predict" \
          -H "accept: application/json" \
          -H "Content-Type: multipart/form-data" \
          -F "file=@test_image.jpg" \
          -w "\n%{http_code}")
        
        http_code=$(echo "$response" | tail -n1)
        
        if [ $http_code -ne 200 ]; then
          echo "Prediction test failed with status $http_code"
          exit 1
        fi
        
        echo "Prediction test passed"
        
        # Cleanup
        rm test_image.jpg
    
    - name: Rollback on failure
      if: failure()
      run: |
        echo "Deployment failed, rolling back..."
        docker-compose -f deployment/docker-compose.yml down
        # You can add logic here to redeploy previous version if needed
    
    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "✅ Deployment successful"
        else
          echo "❌ Deployment failed"
        fi
