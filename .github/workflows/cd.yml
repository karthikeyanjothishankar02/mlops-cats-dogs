name: CD

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # -----------------------------
      # Checkout repository
      # -----------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS files
        run: git lfs pull

      - name: Verify files exist
        run: |
          echo "=== Repository structure ==="
          ls -la
          echo "=== Models folder ==="
          ls -lh models/ || echo "No models folder"
          echo "=== Deployment folder ==="
          ls -la deployment/

      # -----------------------------
      # Docker Setup
      # -----------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull latest image
        run: |
          docker pull ${{ secrets.DOCKER_USERNAME }}/cats-dogs-classifier:latest || echo "No existing image found, will use local build"

      # -----------------------------
      # Deploy with Docker Compose
      # -----------------------------
      - name: Stop existing containers
        run: |
          docker compose -f deployment/docker-compose.yml down --remove-orphans || true
          docker rm -f cats-dogs-classifier 2>/dev/null || true

      - name: Deploy service
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          echo "Starting deployment..."
          docker compose -f deployment/docker-compose.yml up -d --pull always
          
          echo "Container started. Waiting for health check..."
          sleep 10

      - name: Wait for service to be healthy
        run: |
          echo "Checking container status..."
          
          MAX_ATTEMPTS=40
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS"
            
            # Check if container exists and is running
            CONTAINER_STATUS=$(docker inspect -f '{{.State.Status}}' cats-dogs-classifier 2>/dev/null || echo "not_found")
            echo "  Container status: $CONTAINER_STATUS"
            
            if [ "$CONTAINER_STATUS" = "not_found" ]; then
              echo "  Container not found!"
              docker compose -f deployment/docker-compose.yml ps
              sleep 5
              continue
            fi
            
            if [ "$CONTAINER_STATUS" != "running" ]; then
              echo "  Container not running yet..."
              sleep 5
              continue
            fi
            
            # Check health status
            HEALTH=$(docker inspect -f '{{.State.Health.Status}}' cats-dogs-classifier 2>/dev/null || echo "no_health")
            echo "  Health status: $HEALTH"
            
            if [ "$HEALTH" = "healthy" ]; then
              echo "Service is healthy!"
              exit 0
            fi
            
            # Try direct health check
            if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
              echo "Health endpoint responding!"
              exit 0
            fi
            
            sleep 5
          done
          
          echo "=== DEPLOYMENT FAILED ==="
          echo "Container logs:"
          docker logs cats-dogs-classifier 2>&1 | tail -100
          echo ""
          echo "Container inspect:"
          docker inspect cats-dogs-classifier | head -50
          exit 1

      # -----------------------------
      # Smoke Tests
      # -----------------------------
      - name: Run smoke tests
        run: |
          echo "=== Running Smoke Tests ==="
          
          echo "1. Testing health endpoint..."
          HEALTH_RESPONSE=$(curl -sf http://localhost:8000/health)
          echo "   Response: $HEALTH_RESPONSE"
          
          echo "2. Testing root endpoint..."
          ROOT_RESPONSE=$(curl -sf http://localhost:8000/)
          echo "   Response: $ROOT_RESPONSE"
          
          echo "3. Testing metrics endpoint..."
          METRICS_RESPONSE=$(curl -sf http://localhost:8000/metrics)
          echo "   Response: $METRICS_RESPONSE"
          
          echo "4. Testing prediction endpoint..."
          # Create a simple test image using Python
          python3 << 'EOF'
          from PIL import Image
          img = Image.new("RGB", (224, 224), color=(100, 150, 200))
          img.save("test_image.jpg", "JPEG")
          print("Test image created")
          EOF
          
          PREDICT_RESPONSE=$(curl -sf -X POST "http://localhost:8000/predict" \
            -H "accept: application/json" \
            -F "file=@test_image.jpg")
          echo "   Response: $PREDICT_RESPONSE"
          
          rm -f test_image.jpg
          
          echo ""
          echo "=== All smoke tests passed! ==="

      # -----------------------------
      # Cleanup on failure
      # -----------------------------
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Deployment Failed - Debug Info ==="
          echo ""
          echo "Docker containers:"
          docker ps -a
          echo ""
          echo "Docker images:"
          docker images | head -20
          echo ""
          echo "Container logs:"
          docker logs cats-dogs-classifier 2>&1 || echo "No logs available"
          echo ""
          echo "Docker compose config:"
          docker compose -f deployment/docker-compose.yml config

      - name: Cleanup on failure
        if: failure()
        run: |
          docker compose -f deployment/docker-compose.yml down --remove-orphans || true


