name: CD

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

    steps:
      - name: Checkout code with LFS
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Ensure model is present
        run: |
          mkdir -p models
          cp path/to/final_model.pt models/  # <-- replace with actual path in repo
          ls -lh models/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull latest image
        run: |
          docker pull $DOCKER_USERNAME/cats-dogs-classifier:latest || true

      - name: Deploy with Docker Compose
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          docker compose -f deployment/docker-compose.yml down || true
          docker compose -f deployment/docker-compose.yml pull
          docker compose -f deployment/docker-compose.yml up -d cats-dogs-classifier

          echo "Waiting for service to become healthy..."
          for i in {1..30}; do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' cats-dogs-classifier 2>/dev/null || echo "starting")
            echo "Status: $STATUS"
            if [ "$STATUS" = "healthy" ]; then
              echo "Service is healthy"
              break
            fi
            sleep 5
          done

          if [ "$STATUS" != "healthy" ]; then
            echo "Service failed to become healthy. Showing logs..."
            docker logs cats-dogs-classifier
            exit 1
          fi

      - name: Install test dependencies
        run: pip install pillow

      - name: Run smoke tests
        run: |
          echo "Testing health endpoint..."
          curl -f http://localhost:8000/health

          echo "Testing prediction endpoint..."
          python3 - <<EOF
          from PIL import Image
          img = Image.new("RGB", (224, 224), color="blue")
          img.save("test_image.jpg")
          EOF

          curl -f -X POST "http://localhost:8000/predict" \
            -H "accept: application/json" \
            -H "Content-Type: multipart/form-data" \
            -F "file=@test_image.jpg"

          rm test_image.jpg
          echo "Smoke tests passed"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed — rolling back"
          docker compose -f deployment/docker-compose.yml down
          docker logs cats-dogs-classifier || true

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Deployment successful"
          else
            echo "❌ Deployment failed"
          fi
