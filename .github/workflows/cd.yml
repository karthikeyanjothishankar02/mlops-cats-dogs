name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS files
        run: git lfs pull

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull latest image
        run: |
          docker pull ${{ secrets.DOCKER_USERNAME }}/cats-dogs-classifier:latest

      - name: Deploy service
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          docker compose -f deployment/docker-compose.yml down --remove-orphans || true
          docker compose -f deployment/docker-compose.yml up -d --pull always
          sleep 10

      - name: Wait for service to be healthy
        run: |
          MAX_ATTEMPTS=40
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $i/$MAX_ATTEMPTS"
            if curl -sf http://localhost:8000/health; then
              echo "Service is healthy!"
              exit 0
            fi
            sleep 5
          done
          docker logs cats-dogs-classifier
          exit 1

      - name: Run smoke tests
        run: |
          curl -sf http://localhost:8000/health
          curl -sf http://localhost:8000/
          echo "Smoke tests passed!"




